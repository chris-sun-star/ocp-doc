# 部署 OCP

本节为您介绍如何部署 OCP。

前提条件
-------------------------

* 部署 OCP 的宿主机上已安装 Docker，Docker 的安装请参见 [安装 Docker](../2.deployment-guide/8.deploy-appendix/1.install-docker.md)。

<!-- -->

* 已参见 [安装准备](../2.deployment-guide/4.installation-preparation.md) 获取 ocp-3.3.0-ce.tar.gz 软件包。

操作步骤
-------------------------

1. 将 ocp-3.3.0-ce.tar.gz 上传到宿主机的任一目录，并解压，解压后，包含以下文件

* ocp_installer.sh

* ocp.tar.gz

* ocp-installer.tar.gz

* config.yaml

2. 根据实际部署情况，修改 config.yaml 配置文件，配置文件详细说明，请参考(TODO: 链接到下面的配置文件说明)

3. 调用 ocp_installer.sh 进行部署
ocp_installer.sh 的使用方法参考(TODO: 链接下面脚本的使用方法)

下面举例说明几种典型的安装场景:

* 全新安装:
```bash
# 使用密码的方式认证
./ocp_installer.sh install -c config.yaml -i ./ocp-installer.tar.gz -o ./ocp.tar.gz
# 使用密钥文件的方式认证
./ocp_installer.sh install -c config.yaml -k /root/.ssh/id_rsa -i ./ocp-installer.tar.gz -o ./ocp.tar.gz
```

* 升级安装
```bash
# 使用密码的方式认证
./ocp_installer.sh upgrade -c config.yaml -i ./ocp-installer.tar.gz -o ./ocp.tar.gz
# 使用密钥文件的方式认证
./ocp_installer.sh upgrade -c config.yaml -k /root/.ssh/id_rsa -i ./ocp-installer.tar.gz -o ./ocp.tar.gz
```

* 替换OCP容器
```bash
# 使用密码的方式认证
./ocp_installer.sh replace -c config.yaml -i ./ocp-installer.tar.gz -o ./ocp.tar.gz
# 使用密钥文件的方式认证
./ocp_installer.sh replace -c config.yaml -k /root/.ssh/id_rsa -i ./ocp-installer.tar.gz -o ./ocp.tar.gz
```

* 卸载OCP
```bash
# 使用密码的方式认证
./ocp_installer.sh uninstall -c config.yaml -i ./ocp-installer.tar.gz
# 使用密钥文件的方式认证
./ocp_installer.sh uninstall -c config.yaml -k /root/.ssh/id_rsa -i ./ocp-installer.tar.gz
```

配置文件说明
-------------------------
配置文件主要包括几个部分

- metadb 集群配置
- ssh 认证
- ocp 相关配置
- 其他配置
```bash
# OCP 部署配置文件
# 文件中的地址信息不可以使用127.0.0.1或者主机名
# 当主机同时有公网 ip 和私网 ip 时，如果私网 ip 可访问，可以配置私网 ip 以提高传输文件的速度
# 如果配置了 VIP，需要提前申请和绑定好，部署程序不会做 VIP 相关的部署工作，只是使用配置的 VIP 地址来进行访问

# 是否忽略 precheck 的结果，precheck会对部署主机的资源和环境做一些检查判断是否满足一般情况下的部署需求
# 一般不建议忽略 precheck，如果受限于机器资源，或者仅作为测试使用，可以选择忽略
precheck_ignore: false

# METADB 集群相关配置

# 当 create_metadb_cluster 设置为 true 时，会单独创建一个 OB 集群作为 OCP 的 metadb
create_metadb_cluster: false

# 当卸载 OCP 时是否删除 meta obcluster，当这个配置项没有配置的时候，会根据 create_metadb_cluster 来判断
clean_metadb_cluster: false

# metadb ob 集群的配置
ob_cluster:
  # 集群名
  name: ocp_metadb
  # observer 的安装目录
  home_path: /data/0/observer
  # observer 的数据目录，如果不设置，数据将放在安装目录下，建议单独设置
  data_path: /data/1/data
  # observer clog, ilog 和 slog 的目录，如果不设置，将放在安装目录下，建议单独设置
  redo_path: /root/redo
  # observer 的 sql 端口
  sql_port: 2881
  # observer 的 rpc 端口
  rpc_port: 2882
  # ob 集群的所有zone
  zones:
    # zone 名字
    - name: zone1
      # zone 下的所有 server
      servers:
        - 1.1.1.1
  # meta 用户相关配置
  meta:
    # 租户名
    tenant: meta_tenant
    # 用户名
    user: meta_user
    # 用户密码
    password: meta_password
    # meta database 名
    database: meta_database
    # 租户的 CPU
    cpu: 2
    # 租户的内存，单位是 GB
    memory: 8
  # monitor 用户相关配置
  monitor:
    # 租户名
    tenant: monitor_tenant
    # 用户名
    user: monitor_user
    # 用户密码
    password: monitor_password
    # monitor database 名
    database: monitor_database
    # 租户的 CPU
    cpu: 8
    # 租户的内存，单位是 GB
    memory: 16
    
# metadb obproxy 的配置
obproxy:
  # obproxy 的安装路径
  home_path: /data/0/obproxy
  # obproxy 的监听端口
  port: 2883
  # obproxy 部署的 server
  servers:
    - 1.1.1.1
   # VIP 地址，如果有多个obproxy，一般需要一个vip来做负载均衡，如果不配置，会选择一个obproxy的地址
   vip:
     address: 1.1.1.1
     port: 2883

## SSH 认证相关配置
ssh:
  port: 22
  user: root
  # 认证方式，支持 password 或者 pubkey
  auth_method: password
  timeout: 10
  password: password
  
# OCP 相关配置
ocp:
  # OCP 容器的名字
  name: 'ocp-330'

  # OCP 进程相关配置，包括端口号和日志路径
  process:
    # OCP 进程监听端口
    port: 8080
    # OCP 日志文件在宿主机上的路径
    log_dir: /tmp/ocp/log
  # OCP 部署的主机
  servers:
    - 1.1.1.1
  # OCP 容器的资源限制
  resource:
    cpu: 4
    # 内存资源限制，单位是 GB
    memory: 8
  # OCP VIP 配置，如果不配置，会选择一个 OCP 主机的地址
  vip:
    address: 1.1.1.1
    port: 8080

  # OCP 认证配置，在升级场景下会使用
  auth:
    user: admin
    password: root

  # OCP metadb 的连接信息，如果在上面配置了创建一个单独的 metadb 集群，会使用创建的集群的信息
  metadb:
    host: 1.1.1.1
    port: 2883
    meta_user: meta_user@meta_tenant#ocp_metadb
    meta_password: meta_password
    meta_database: meta_database
    monitor_user: monitor_user@monitor_tenant#ocp_metadb
    monitor_password: monitor_password
    monitor_database: monitor_database
```

部署脚本使用方法
-------------------------
```bash
#./ocp_installer.sh help

Usage:
./ocp_installer.sh COMMAND -c config_file -i installer_image_file [-o ocp_image_file] [-k ssh_key_file] [-v] [-h]
Description:
OCP installer

Commands:
  install      install OCP
  uninstall    delete OCP and metadb(if configured)
  upgrade      upgrade OCP
  replace      replace OCP container, used for upgrade to the bp version, or just restart

Options:
  -c           required, path to config file
  -i           installer image file
  -o           ocp image file
  -k           ssh_key_file
  -v           show verbose messages
  -h           show this help mesages
```

